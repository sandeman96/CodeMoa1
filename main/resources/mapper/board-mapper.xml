<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="boardMapper">
	<select id="getListCount" resultType="_int">
		select count(*) from board where b_status='Y' and b_type=#{bType} 
	</select>

	<select id="selectList" parameterType="hashmap" resultMap="boardResultSet">					
			SELECT *
			FROM (
			SELECT b.b_no, b.b_type, b.b_title, b.b_content, b.b_date, b.b_count, b.b_status, 
			b.b_first, b.b_writer, m.m_nick, 
			(SELECT COUNT(r.r_no) FROM reply r WHERE r.r_bno = b.b_no and r.r_status='Y') as "rCount",
			(SELECT COUNT(l.l_no) FROM likey l WHERE l.l_bno = b.b_no) as "lCount"
			 FROM board b join member m on (b.b_writer = m.m_id)
			 WHERE b.b_status = 'Y' and b.b_type=#{bType} order by b_first desc
			<if test="standard == 'bNo'">
				, b_no desc)
			</if>
			<if test="standard == 'bCount'">
				, b_count desc)
			</if>
			<if test="standard == 'lCount'">
				, "lCount" desc)
			</if>
			<if test="standard == 'rCount'">
				, "rCount" desc)
			</if>
	</select>
	<resultMap type="Board" id="boardResultSet">
		<id column="B_NO" property="bNo" />
		<result column="B_TYPE" property="bType" />
		<result column="B_TITLE" property="bTitle" />
		<result column="B_CONTENT" property="bContent" />
		<result column="M_NICK" property="nickName" />
		<result column="B_DATE" property="bDate" />
		<result column="B_COUNT" property="bCount" />
		<result column="B_STATUS" property="bStatus" />
		<result column="B_FIRST" property="bFirst" />
		<result column="B_WRITER" property="bWriter" />
		<result column="lCount" property="lCount" />
		<result column="rCount" property="rCount" />
	</resultMap>

	<insert id="insertBoard">
		insert into board values (seq_bno.nextval, #{bType}, #{bTitle}, #{bContent},
		sysdate, default, default, default, #{bWriter})
	</insert>
	
	<update id="addCount">
		update board set b_count = b_count +1
		where b_no=#{bNo}
	</update>
	<select id="selectBoard" resultMap="boardResultSet">
		SELECT *
			FROM (
			SELECT b.b_no, b.b_type, b.b_title, b.b_content, b.b_date, b.b_count, b.b_status, 
			b.b_first, b.b_writer, m.m_nick, 
			(SELECT COUNT(r.r_no) FROM reply r WHERE r.r_bno = b.b_no and r.r_status='Y') as "rCount",
			(SELECT COUNT(l.l_no) FROM likey l WHERE l.l_bno = b.b_no) as "lCount"
			 FROM board b join member m on (b.b_writer = m.m_id)
			 WHERE b.b_status = 'Y' and b_no=#{bNo})
	</select>
	<update id="updateBoard">
		update board set b_type=#{bType}, b_title=#{bTitle}, b_content=#{bContent}
		where b_no=#{bNo}
	</update>
	<update id="deleteBoard">
		update board
		set b_status='N'
		where b_no=#{bNo}
	</update>

	<select id="selectLike" resultMap="likeResultSet">
		select *
		from likey
		where l_bno=#{lBNo} and l_id=#{lId}
	</select>
	
	<delete id="deleteLike">
		delete from likey
		where l_bno=#{lBNo} and l_id=#{lId}
	</delete>
	
	<insert id="insertLike">
		insert into likey values (seq_lno.nextval, #{lId}, #{lBNo})
	</insert>

	<resultMap type="Likey" id="likeResultSet">
		<id column="L_NO" property="lNo" />
		<result column="L_ID" property="lId" />
		<result column="L_BNO" property="lBNo" />
	</resultMap>
	
	<insert id="insertReply">
		insert into Reply values (seq_rno.nextval, sysdate, #{rContent}, default, #{rWriter}, #{rBNo})
	</insert>
	<select id="selectReplyList" resultMap="replyResultSet">
  		select r_no, r_date, r_content, r_status, m_nick, r_bno, r_writer from reply
  		join member on (r_writer = m_id) join board on (r_bno=b_no)
  		where r_bno = #{bNo}
  		and r_status = 'Y'
  		order by r_no desc
  	</select>
  	<resultMap type="Reply" id="replyResultSet">
  		<id column="R_NO" property="rNo"/>
  		<result column="R_DATE" property="rDate"/>
	  	<result column="R_CONTENT" property="rContent"/>
	  	<result column="R_STATUS" property="rStatus"/>
	  	<result column="R_WRITER" property="rWriter"/>
	  	<result column="R_BNO" property="rBNo"/>
	  	<result column="M_NICK" property="nickName"/>
	 </resultMap>
	 <update id="updateReply">
		update reply set r_content=#{rContent}
		where r_no=#{rNo}
	</update>
	<update id="deleteReply">
		update reply
		set r_status='N'
		where r_no=#{rNo}
	</update>
</mapper>
